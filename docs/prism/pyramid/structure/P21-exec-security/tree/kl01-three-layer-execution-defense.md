# KL39: 构建分段解析、白名单校验与动态审批的三重防线，强制阻断高风险管道执行模式

> 所属视角：P21-exec-security
> 上层论点：执行安全机制需构建“分段解析 + 白名单校验 + 动态审批”的三重防线，强制阻断高风险的 curl|bash 管道执行模式并防止配置回退失效。

## 支撑论点

### 39.1: 默认机制通过分段解析与严格白名单，自动拦截含 curl 和 bash 的高风险管道命令

- 逻辑顺序：结构
- 引用 atoms: EX-01, EX-02, EX-03, EX-04, EX-16
- 引用 groups: G39

系统默认将含管道符的命令拆解为独立段进行校验，由于 `safeBins` 仅包含基础文本处理工具（如 jq, cut）而明确排除 `curl` 和 `bash`，且 `bash` 因具备从 stdin 执行任意脚本的高风险特性永不被视为安全\_bin，导致此类管道命令在无显式配置下被强制阻断。

### 39.2: 需显式配置 Allowlist 或启用 On-Miss 审批策略，以建立可控的命令放行通道

- 逻辑顺序：程度
- 引用 atoms: EX-05, EX-06, EX-07, EX-10, EX-15
- 引用 groups: G39

为防止配置空值导致系统回退至“直接拒绝”模式，必须在 `exec-approvals.json` 中为 agent 设置 `security=allowlist` 并配合 `ask=on-miss` 策略，或通过手动追加路径模式至 allowlist 数组，从而在阻断默认风险的同时提供明确的审批或永久放行入口。

### 39.3: 确保网关执行环境与配置热加载机制生效，避免沙箱隔离与会话状态导致的策略失效

- 逻辑顺序：时间
- 引用 atoms: EX-08, EX-11, EX-12, EX-13, EX-14
- 引用 groups: G39

只有将 `tools.exec.host` 显式设置为 `gateway` 才能触发审批逻辑（避免在 sandbox 中绕过），且配置修改后需开启新 Session 以清除旧状态覆盖，利用系统每次请求重新读取磁盘配置的特性实现策略的热更新与持久化生效。

## 论点间关系

子论点遵循“防御原理（如何阻断）-> 配置策略（如何放行）-> 运行保障（如何生效）”的结构逻辑，层层递进地构建了从默认拦截到可控执行再到环境落地的完整安全闭环。

---
