# KL13: 通过统一注册 API 与分层发现机制构建灵活扩展的插件生态基础

> 所属视角：P13-extension-system
> 上层论点：构建“清单驱动 + SDK 隔离 + 动态审批”的三重防御体系：通过统一注册与分层发现实现灵活扩展，利用 jiti 动态加载与严格路径检查保障运行时安全，并强制实施分段解析与白名单校验以阻断高风险执行模式。

## 支撑论点

### 13.1: 实施严格的 SDK 隔离架构与清单驱动的开发规范，确保插件能力边界清晰且系统稳定

- 逻辑顺序：结构
- 引用 atoms: PC-03, PC-04, PC-09, PC-10
- 引用 groups: G32

插件开发必须严格依赖官方 `openclaw/plugin-sdk`，严禁直接导入内部 `src` 模块，运行时能力需通过 `api.runtime` 注入获取。开发者需建立包含 `openclaw.plugin.json` 清单和 `index.ts` 入口的标准目录结构，其中清单 ID 为全局唯一标识符，以此实现编译时稳定与运行时注入的分离。

### 13.2: 建立基于优先级扫描的分层发现机制，支持从内置包到工作区扩展的多样化插件来源

- 逻辑顺序：结构
- 引用 atoms: PC-05, PC-06, PC-11
- 引用 groups: G32

系统按优先级扫描 config 指定路径、workspace 扩展、global 扩展及 bundled 内置扩展四个来源，识别含清单的包目录、顶层脚本或特定 npm 包三种形式。非 bundled 来源的插件必须在配置中显式设置 `enabled: true` 方可启用，从而在灵活扩展与可控加载之间取得平衡。

### 13.3: 提供统一且类型安全的注册 API 体系，覆盖工具、通道、认证及服务等多种核心能力的动态挂载

- 逻辑顺序：结构
- 引用 atoms: PC-12, PC-13, PC-14, PC-15, PC-16, PC-17, PC-18
- 引用 groups: G32

通过 `registerTool`、`registerChannel`、`registerProvider` 等统一接口，支持静态定义、工厂模式及五种认证类型的灵活注册。推荐使用 `api.on()` 获取完整类型推导，并允许单个插件同时注册多种能力（如工具、CLI、HTTP handler 及后台服务），实现功能的高度聚合与解耦。

### 13.4: 构建包含 22 个生命周期切面的 Hook 系统，赋予插件在关键执行节点拦截与修改行为的深度控制力

- 逻辑顺序：程度
- 引用 atoms: PC-19, PC-20, PC-21, PC-22
- 引用 groups: G32

Hook 系统分为只读与可写两类，其中可写 Hook（如 `before_tool_call`、`message_sending`）允许插件修改参数、阻断执行或取消发送。这种机制使插件能够深度介入工具调用、消息发送及子 Agent 创建等核心流程，实现从被动扩展到主动治理的能力跃升。

### 13.5: 执行多重安全校验与动态加载策略，利用 jiti 即时编译与路径权限检查阻断高风险执行模式

- 逻辑顺序：时间
- 引用 atoms: PC-02, PC-07, PC-25, PC-30, PC-31
- 引用 groups: G32

加载流程严格执行清单验证、ID 冲突检查及配置 Schema 匹配，随后利用 `jiti` 直接加载 TypeScript 文件无需预编译。在运行时，系统拒绝世界可写路径并验证文件所有者一致性，对未记录的非 bundled 插件触发安全警告，确保从加载到执行的全链路安全。

## 论点间关系

上述论点遵循插件全生命周期的逻辑结构：首先确立开发规范与架构隔离（13.1），继而通过分层机制实现插件的发现与识别（13.2），随后利用统一 API 与 Hook 系统完成能力的注册与深度扩展（13.3-13.4），最后通过严格的安全校验与动态加载流程保障运行时环境的可靠性（13.5）。

---
