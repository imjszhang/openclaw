# KL06: 架构基石需确立“本地优先网关”核心枢纽，通过五层抽象连接多渠道与多工具以实现安全路由

> 所属视角：P06-model-agent-config
> 上层论点：AI 模型与 Agent 配置必须严格遵循“提供商认证机制”与“多 Agent 路由逻辑”的解耦原则，并通过强制区分主/子 Agent 构建模式、禁止跨实例复用配置目录，结合独立工作区与会话隔离，实现灵活调度下的绝对安全与人设独立。

## 支撑论点

### 6.1: 构建以"Channel-Agent-Workspace-Session"五层抽象为核心的消息流转架构，确保从渠道接入到工具执行的全链路逻辑解耦

- 逻辑顺序：结构
- 引用 atoms: CP-01, CP-02, CP-03, CP-04
- 引用 groups: G28

该架构将消息平台（Channel）、登录实例（Account）、大脑逻辑（Agent）与上下文（Session）彻底分离，通过 bindings 路由机制实现消息从通道账户接收、加载 Workspace 执行到原路返回的精准闭环。这种分层设计不仅明确了各组件职责，更为多代理路由和复杂场景下的资源调度提供了标准化的结构基础。

### 6.2: 实施严格的物理与逻辑隔离机制，通过独立工作区、禁止配置复用及会话分桶策略保障人设独立与数据安全

- 逻辑顺序：程度
- 引用 atoms: CP-05, CP-06, CP-10, CP-11, CP-12
- 引用 groups: G28

系统强制要求每个 Agent 拥有独立的 Workspace 目录存储人设与技能，严禁跨实例复用 agentDir 配置，且凭证需手动复制以防冲突。配合基于 SessionKey 的串行锁机制与文件锁保护，以及 `per-channel-peer` 等细粒度分桶策略，有效杜绝了不同联系人间的上下文泄露与并发写入风险。

### 6.3: 依托“本地优先网关”作为单一控制平面，统一纳管多渠道协议验证、请求路由及多工具能力扩展

- 逻辑顺序：结构
- 引用 atoms: AR-10, AR-11, AR-12, AR-15, CP-13
- 引用 groups: G15, G28

Gateway 作为核心枢纽（端口 18789），承担 WebSocket 服务、协议验证及事件广播职责，连接 WhatsApp、Telegram 等 13+ 通道与 runtime、fs、web 等八大类工具组。它不仅实现了消息的统一入口与出口管理，还通过 Node 配对机制扩展了 Canvas、Camera 等原生能力，确保所有交互均在受控的安全边界内运行。

## 论点间关系

上述论点遵循“宏观架构定义 → 微观安全落地 → 核心枢纽支撑”的结构逻辑：首先确立五层抽象的整体数据流框架，继而在此基础上实施严格的隔离与并发控制以保障安全，最后由本地优先网关提供统一的连接与执行底座，三者共同构成稳固的架构基石。

---
