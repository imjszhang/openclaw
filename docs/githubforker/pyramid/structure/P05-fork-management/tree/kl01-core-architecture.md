# KL28: Fork 管理必须采用"三层分支隔离 + 选择性同步"策略，通过架构级的分支隔离与智能化的差异同步机制，在确保定制功能独立存活的同时，自动化吸纳上游核心演进，实现生产环境的持续稳定。

> 所属视角：P05-fork-management
> 上层论点：架构基石：以"本地优先网关"为核心枢纽，通过五层抽象连接多渠道与多工具，实现安全路由与上下文精准管理

## 支撑论点

### 28.1: 基于"Channel-Agent-Workspace"五层抽象架构，建立物理与逻辑隔离的分支策略，确保定制工作区（Workspace）与核心凭证配置（AgentDir）的独立演进。

- 逻辑顺序：结构
- 引用 atoms: CP-01, CP-04, CP-06, CP-10
- 引用 groups: G28

OpenClaw 架构将消息平台、身份实例、大脑逻辑与工作空间彻底解耦，其中 Workspace 存储用户可编辑的人设与技能，而 AgentDir 存储系统级的认证与模型配置。Fork 管理应利用此天然隔离，将定制业务逻辑锁定在 Workspace 分支，而将核心凭证与路由配置保留在受控的上游同步分支，避免复用 agentDir 导致的配置冲突。

### 28.2: 实施"核心网关同步 + 插件钩子定制"的选择性合并机制，在自动化吸纳上游 Gateway 与通道协议演进的同时，通过沙箱与钩子保留本地差异化能力。

- 逻辑顺序：程度
- 引用 atoms: AR-11, AR-29, AR-30, CP-13, CP-20
- 引用 groups: G15, G28

上游的核心演进主要集中在 Gateway 的 WebSocket 服务、协议验证及多通道支持（如 WhatsApp/Telegram 更新），这些必须通过自动化流程同步以维持连接稳定性。而本地定制应聚焦于 `before/after_tool_call` 等插件钩子逻辑及沙箱权限配置（mode=non-main），通过 Git 策略仅合并核心架构代码，拒绝覆盖本地的安全策略与扩展钩子。

### 28.3: 构建基于会话键（SessionKey）与串行队列的回归测试防线，验证分支合并后的并发安全性与上下文隔离完整性，防止生产环境数据泄露。

- 逻辑顺序：时间
- 引用 atoms: CP-07, CP-09, CP-12, CP-19, AR-25
- 引用 groups: G28

在合并上游代码后，必须依据 `per-channel-peer` 等会话键策略进行回归测试，验证全局 CommandLane 与按 SessionKey 串行机制是否正常工作。重点检查多用户 DM 场景下的上下文分桶策略及文件锁保护机制，确保分支更新未破坏原有的并发控制与数据隔离防线。

## 论点间关系

上述论点遵循“静态架构隔离 → 动态代码同步 → 运行时安全验证”的逻辑递进关系：首先利用五层抽象确立物理分支边界，其次在代码层面执行差异化的选择性合并策略，最后通过严格的并发与会话测试确保合并后的系统在生产环境的稳定性。

---
